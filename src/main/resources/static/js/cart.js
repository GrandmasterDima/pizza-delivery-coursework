// –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è  –≤—ñ–¥–º–∞–ª—å–æ–≤—É—î –∫–æ—à–∏–∫
function renderCart() {
    //–î—ñ—Å—Ç–∞—î–º–æ –¥–∞–Ω—ñ –∑ –ø–∞–º'—è—Ç—ñ –±—Ä–∞—É–∑–µ—Ä–∞ –∞–±–æ –±–µ—Ä–µ–º–æ –ø—É—Å—Ç–∏–π –º–∞—Å–∏–≤
    const cart = JSON.parse(localStorage.getItem('pizzaCart')) || [];
    //–ó–Ω–∞—Ö–æ–¥–∏–º–æ –∫—É–¥–∏ –≤—Å—Ç–∞–≤–ª—è—Ç–∏ –ø—ñ—Ü–∏ —ñ –¥–µ –ø–∏—Å–∞—Ç–∏ —Å—É–º—É
    const container = document.getElementById('cart-items-list');
    const totalSection = document.querySelector('.total-section');

    // –Ø–∫—â–æ –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π - –≤–∏–≤–æ–¥–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    if (cart.length === 0) {
        container.innerHTML = '<p style="text-align: center; padding: 20px;">–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π üòî</p>';
        totalSection.innerHTML = '–í—Å—å–æ–≥–æ: <span id="cart-total">0</span> ‚Ç¥';
        return;
    }

    let html = ''; //–î–ª—è html
    let total = 0; //–î–ª—è –∑–∞–≥–∞–ª—å–Ω–æ—ó –≤–∞—Ä—Ç–æ—Å—Ç—ñ
    let allPrices = []; //–ú–∞—Å–∏–≤ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —Ü—ñ–Ω –∫–æ–∂–Ω–æ—ó –æ–∫—Ä–µ–º–æ—ó –ø—ñ—Ü–∏

    // –ü—Ä–æ—Ö–æ–¥–∏–º–æ—Å—è –ø–æ –∫–æ–∂–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É
    cart.forEach((item, index) => {
        // –†–∞—Ö—É—î–º–æ –∑–∞–≥–∞–ª—å–Ω—É –≤–∞—Ä—Ç—ñ—Å—Ç—å
        total += item.price * item.quantity;

        //–ù–∞–ø—Ä–∏–∫–ª–∞–¥ —è–∫—â–æ –∑–∞–º–æ–≤–∏–ª–∏ 2 –ø—ñ—Ü–∏ –ø–æ 200 –≥—Ä–Ω, –¥–æ–¥–∞—î–º–æ –≤ –º–∞—Å–∏–≤: [200, 200]
        // –¶–µ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± –ø–æ—Ç—ñ–º –∑–Ω–∞–π—Ç–∏ –Ω–∞–π–º–µ–Ω—à—É —Ü—ñ–Ω—É —Å–µ—Ä–µ–¥ –≤—Å—ñ—Ö –ø—ñ—Ü
        for (let i = 0; i < item.quantity; i++) {
            allPrices.push(parseFloat(item.price));
        }

        // –§–æ—Ä–º—É—î–º–æ HTML –¥–ª—è –æ–¥–Ω—ñ—î—ó –ø—ñ—Ü–∏ (–∫–∞—Ä—Ç–∏–Ω–∫–∞, –Ω–∞–∑–≤–∞, –∫–Ω–æ–ø–∫–∏ +/-)
        html += `
            <div class="cart-item">
                <img src="${item.img}" alt="${item.name}">
                <div class="item-info">
                    <h3>${item.name}</h3>
                    <p>${item.price} ‚Ç¥</p>
                </div>
                <div class="item-controls">
                    <button onclick="changeQty(${index}, -1)">-</button>
                    <span style="margin: 0 10px; font-weight: bold;">${item.quantity}</span>
                    <button onclick="changeQty(${index}, 1)">+</button>
                </div>
            </div>
        `;
    });

    // –í—Å—Ç–∞–≤–ª—è—î–º–æ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π HTML –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É
    container.innerHTML = html;

    // –õ–æ–≥—ñ–∫–∞ –∞–∫—Ü—ñ—ó "10+1"
    if (allPrices.length >= 11) {
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –Ω–∞–π–º–µ–Ω—à–µ —á–∏—Å–ª–æ –≤ –º–∞—Å–∏–≤—ñ —Ü—ñ–Ω
        const minPrice = Math.min(...allPrices);
        // –í—ñ–¥–Ω—ñ–º–∞—î–º–æ –π–æ–≥–æ –≤—ñ–¥ –∑–∞–≥–∞–ª—å–Ω–æ—ó —Å—É–º–∏
        const finalTotal = total - minPrice;

        //–í—ñ–¥–º–∞–ª—å–æ–≤—É—î–º–æ –±–ª–æ–∫ –∑—ñ –∑–Ω–∏–∂–∫–æ—é
        totalSection.innerHTML = `
            <div class="discount-message">
                –í—ñ—Ç–∞—î–º–æ –ê–∫—Ü—ñ—è "10+1": –ó–Ω–∏–∂–∫–∞ <b>-${minPrice} ‚Ç¥</b> –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞!
            </div>
            <div style="margin-top: 5px;">
                –í—Å—å–æ–≥–æ: <span class="old-price">${total}</span>
                <span class="final-price">${finalTotal}</span> ‚Ç¥
            </div>
        `;
    } else {
        // –Ø–∫—â–æ –ø—ñ—Ü –º–µ–Ω—à–µ 11 - –ø–æ–∫–∞–∑—É—î–º–æ –∑–≤–∏—á–∞–π–Ω—É —Å—É–º—É
        totalSection.innerHTML = `–í—Å—å–æ–≥–æ: <span id="cart-total" style="font-weight: bold; font-size: 24px;">${total}</span> ‚Ç¥`;
    }
}

//–§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–º—ñ–Ω–∏ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –ø—ñ—Ü
function changeQty(index, change) {
    let cart = JSON.parse(localStorage.getItem('pizzaCart'));

    // –ó–º—ñ–Ω—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å (+1 –∞–±–æ -1)
    cart[index].quantity += change;

    // –Ø–∫—â–æ —Å—Ç–∞–ª–æ 0 –∞–±–æ –º–µ–Ω—à–µ - –≤–∏–¥–∞–ª—è—î–º–æ —Ç–æ–≤–∞—Ä –∑ –º–∞—Å–∏–≤—É
    if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
    }

    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞–∑–∞–¥ —É –±—Ä–∞—É–∑–µ—Ä —ñ –ø–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ –µ–∫—Ä–∞–Ω
    localStorage.setItem('pizzaCart', JSON.stringify(cart));
    renderCart();
}

//–§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–≤–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è
function clearCart() {
    const cart = JSON.parse(localStorage.getItem('pizzaCart')) || [];
    if (cart.length === 0) {
        alert("–ö–æ—à–∏–∫ –≤–∂–µ –ø–æ—Ä–æ–∂–Ω—ñ–π!");
        return;
    }
    // –ü–∏—Ç–∞—î–º–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
    if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –ø–æ–≤–Ω—ñ—Å—Ç—é –æ—á–∏—Å—Ç–∏—Ç–∏ –∫–æ—à–∏–∫?")) {
        localStorage.removeItem('pizzaCart'); // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å–µ
        renderCart(); // –ü–µ—Ä–µ–º–∞–ª—å–æ–≤—É—î–º–æ
    }
}
// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –∑—ñ–±—Ä–∞–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó  –Ω–∞ —Å–µ—Ä–≤–µ—Ä
// async –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–ª–∏, —â–æ–± —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–æ–Ω—É–≤–∞–ª–∞—Å—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —Ç–æ–±—Ç–æ –Ω–µ –±–ª–æ–∫—É–≤–∞–ª–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É, –ø–æ–∫–∏ —á–µ–∫–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞
async function submitOrder() {

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ—à–∏–∫
    // –î—ñ—Å—Ç–∞—î–º–æ –∫–æ—à–∏–∫ —ñ–∑ –ø–∞–º'—è—Ç—ñ –±—Ä–∞—É–∑–µ—Ä–∞. –Ø–∫—â–æ —Ç–∞–º –Ω—ñ—á–æ–≥–æ –Ω–µ–º–∞—î (null), —Å—Ç–≤–æ—Ä—é—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ–π –º–∞—Å–∏–≤ [].
    const cart = JSON.parse(localStorage.getItem('pizzaCart')) || [];

    // –Ø–∫—â–æ –¥–æ–≤–∂–∏–Ω–∞ –º–∞—Å–∏–≤—É 0 ‚Äî –∑–Ω–∞—á–∏—Ç—å –∫–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π. –ó—É–ø–∏–Ω—è—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é.
    if (cart.length === 0) {
        alert('–ö–æ—à–∏–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π!');
        return;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∞–¥—Ä–µ—Å—É
    // –®—É–∫–∞—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É –≤ HTML –∑–∞ –π–æ–≥–æ ID
    const addressInput = document.getElementById('clientAddress');

    // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ–º–∏–ª–æ–∫: —è–∫—â–æ –º–∏ —Ä–∞–ø—Ç–æ–º –∑–º—ñ–Ω–∏–ª–∏ HTML —ñ –≤–∏–¥–∞–ª–∏–ª–∏ —Ü–µ –ø–æ–ª–µ,
    // –∫–æ–¥ –Ω–µ –≤–ø–∞–¥–µ, –∞ –ø–æ–≤—ñ–¥–æ–º–∏—Ç—å –ø—Ä–æ –ø–æ–º–∏–ª–∫—É.
    if (!addressInput) {
        alert("–ü–æ–º–∏–ª–∫–∞: –ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª–µ –∞–¥—Ä–µ—Å–∏!");
        return;
    }

    // –ë–µ—Ä–µ–º–æ —Ç–µ–∫—Å—Ç, —è–∫–∏–π –≤–≤—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
    const address = addressInput.value;

    // –Ø–∫—â–æ —Ä—è–¥–æ–∫ –ø–æ—Ä–æ–∂–Ω—ñ–π ‚Äî —Å–≤–∞—Ä–∏–º–æ—Å—å.
    if (!address) {
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –∞–¥—Ä–µ—Å—É!');
        return;
    }

    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é
    // –î—ñ—Å—Ç–∞—î–º–æ –æ–±'—î–∫—Ç –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π –º–∏ –∑–±–µ—Ä–µ–≥–ª–∏ –ø—Ä–∏ –≤—Ö–æ–¥—ñ (Login)
    const user = JSON.parse(localStorage.getItem('currentUser'));

    // –Ø–∫—â–æ user  null –ê–ë–û —É –Ω—å–æ–≥–æ –Ω–µ–º–∞—î ID ‚Äî –∑–Ω–∞—á–∏—Ç—å –≤—ñ–Ω –Ω–µ –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π.
    if (!user || !user.id) {
        alert("–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å –≤ —Å–∏—Å—Ç–µ–º—É, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!");
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫—É –≤—Ö–æ–¥—É
        window.location.href = '/login';
        return;
    }

    // –ú–∞–ø–ø—ñ–Ω–≥
    // –ù–∞–º —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–∏—Ö –∫–æ—à–∏–∫–∞ –≤ —Ç–æ–π —Ñ–æ—Ä–º–∞—Ç, —è–∫–∏–π —á–µ–∫–∞—î Java-—Å–µ—Ä–≤–µ—Ä.
    // –£ –∫–æ—à–∏–∫—É: [{id: 1, quantity: 2}] -> –¶–µ –æ–∑–Ω–∞—á–∞—î "–ü—ñ—Ü–∞ ‚Ññ1 —É –∫—ñ–ª—å–∫–æ—Å—Ç—ñ 2 —à—Ç"
    // –°–µ—Ä–≤–µ—Ä —á–µ–∫–∞—î: [1, 1] -> –ü—Ä–æ—Å—Ç–æ —Å–ø–∏—Å–æ–∫ ID

    let pizzaIds = [];
    cart.forEach(item => {
        // –¶–∏–∫–ª –∫—Ä—É—Ç–∏—Ç—å—Å—è —Å—Ç—ñ–ª—å–∫–∏ —Ä–∞–∑—ñ–≤, —Å–∫—ñ–ª—å–∫–∏ –ø—ñ—Ü —Ü—å–æ–≥–æ –≤–∏–¥—É –∑–∞–º–æ–≤–∏–ª–∏ (item.quantity)
        for(let i=0; i < item.quantity; i++) {
            // parseInt –≥–∞—Ä–∞–Ω—Ç—É—î, —â–æ –º–∏ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —á–∏—Å–ª–æ, –∞ –Ω–µ —Ä—è–¥–æ–∫
            pizzaIds.push(parseInt(item.id));
        }
    });

    // –§–æ—Ä–º—É—î–º–æ —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π –æ–±'—î–∫—Ç (JSON), —è–∫–∏–π –ø–æ–ª–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
    const orderData = {
        clientId: parseInt(user.id),
        address: address,
        pizzaIds: pizzaIds
    };

    // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    try {
        // fetch - —Ü–µ –∑–∞–ø–∏—Ç –≤ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç (–Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–µ—Ä)
        // await –æ–∑–Ω–∞—á–∞—î —á–µ–∫–∞–π, –ø–æ–∫–∏ —Å–µ—Ä–≤–µ—Ä –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å, –ø–µ—Ä—à –Ω—ñ–∂ –π—Ç–∏ –¥–∞–ª—ñ
        const response = await fetch('/api/orders', {
            method: 'POST', // –ú–µ—Ç–æ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–∏—Ö
            headers: { 'Content-Type': 'application/json' }, // –ö–∞–∂–µ–º–æ —Å–µ—Ä–≤–µ—Ä—É, —â–æ —à–ª–µ–º–æ JSON
            body: JSON.stringify(orderData) // –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç JS —É —Ç–µ–∫—Å—Ç–æ–≤–∏–π —Ä—è–¥–æ–∫ JSON
        });

        // response.ok = true, —è–∫—â–æ —Å—Ç–∞—Ç—É—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ 200-299 (–£—Å–ø—ñ—Ö)
        if (response.ok) {
            // –ß–∏—Ç–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–∞–º –º–∞—î –±—É—Ç–∏ ID –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —ñ —Å—É–º–∞)
            const result = await response.json();
            alert(`–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ${result.id} —É—Å–ø—ñ—à–Ω–æ –ø—Ä–∏–π–Ω—è—Ç–æ! –°—É–º–∞: ${result.totalAmount} –≥—Ä–Ω`);

            //–û—á–∏—â–∞—î–º–æ –∫–æ—à–∏–∫ —Ç—ñ–ª—å–∫–∏ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!
            localStorage.removeItem('pizzaCart');

            // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–∞ –≥–æ–ª–æ–≤–Ω—É —Å—Ç–æ—Ä—ñ–Ω–∫—É
            window.location.href = '/';
        } else {
            // –Ø–∫—â–æ —Å–µ—Ä–≤–µ—Ä –ø–æ–≤–µ—Ä–Ω—É–≤ –ø–æ–º–∏–ª–∫—É
            alert('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.');
        }
    } catch (e) {
        // –¶–µ–π –±–ª–æ–∫ —Å–ø—Ä–∞—Ü—é—î, —è–∫—â–æ —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–Ω–∏–∫ –∞–±–æ —Å–µ—Ä–≤–µ—Ä –≤–∑–∞–≥–∞–ª—ñ –≤–∏–º–∫–Ω–µ–Ω–∏–π
        console.error(e);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑\'—î–¥–Ω–∞—Ç–∏—Å—è –∑ —Å–µ—Ä–≤–µ—Ä–æ–º.');
    }
}
//–ó–∞–ø—É—Å–∫–∞—î–º–æ —Ä–µ–Ω–¥–µ—Ä –ø—Ä–∏ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏
document.addEventListener('DOMContentLoaded', () => {
    renderCart();
});